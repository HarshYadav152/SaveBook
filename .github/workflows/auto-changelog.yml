name: Auto Generate Changelog

on:
  push:
    branches:
      - main
      - master
    paths-ignore:
      - 'CHANGELOG.md'  # Prevent infinite loops

jobs:
  changelog:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'docs: auto update changelog')"

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT }}  # Use PAT for checkout

      - name: Generate Changelog Entry
        run: |
          # Get commits since last changelog update
          LAST_COMMIT=$(git log --oneline -n 1 --grep="docs: auto update changelog" --format="%H" 2>/dev/null || git rev-list --max-parents=0 HEAD)
          
          # Get new commits (excluding auto-updates)
          echo "## $(date '+%Y-%m-%d')" > NEW_ENTRY.md
          git log --pretty=format:"- %s [%h]" --no-merges --invert-grep --grep="docs: auto update changelog" $LAST_COMMIT..HEAD >> NEW_ENTRY.md
          echo "" >> NEW_ENTRY.md
          
          # Prepend to existing changelog
          if [ -f CHANGELOG.md ]; then
            cat CHANGELOG.md >> NEW_ENTRY.md
          fi
          mv NEW_ENTRY.md CHANGELOG.md

      - name: Commit & Push Changelog
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs: auto update changelog"
          file_pattern: CHANGELOG.md
          commit_user_name: "GitHub Actions"
          commit_user_email: "actions@github.com"